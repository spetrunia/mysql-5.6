#
# Range Locking : tests for SeekForUpdate feature
#

--source include/have_rocksdb.inc
--source suite/rocksdb/include/have_range_locking.inc
--enable_connect_log
show variables like 'rocksdb_use_range_locking';

create table t0(a int primary key);
insert into t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);

create table t1 (
  pk int,
  a int,
  primary key (pk)
) engine=rocksdb;

insert into t1 select
  A.a + B.a*10 + C.a*100,
  A.a + B.a*10 + C.a*100
from 
  t0 A, t0 B, t0 C;

--echo # Make another connection to get the lock tree out of the STO-mode
connect (con1,localhost,root,,);
connection con1;
begin;
select * from t1 where pk=10 for update;

connection default;
begin;
select * from t1 where pk=11 for update;

--echo # Now, we will just see locks on 10=0xA and 11=0xB:
--source suite/rocksdb/include/select_from_is_rowlocks.inc

--echo #
--echo #  SeekForUpdate Test #1: A query with type=range (without upper bound) and LIMIT 
--echo #
--replace_column 9 #
explain
select * from t1 where pk>=500 order by pk limit 3 for update;
select * from t1 where pk>=500 order by pk limit 3 for update;
--source suite/rocksdb/include/select_from_is_rowlocks.inc
rollback;


begin;
select * from t1 where pk=11 for update;
explain
select * from t1 order by pk limit 3 for update;
select * from t1 order by pk limit 3 for update;

--source suite/rocksdb/include/select_from_is_rowlocks.inc

rollback;
connection con1;
rollback;
disconnect con1;
connection default;
drop table t0, t1;

